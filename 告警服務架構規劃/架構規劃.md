# æ¶æ§‹è¦åŠƒ

ç³»çµ±æ‹†åˆ†æˆ **å…©å€‹ä¸»è¦æœå‹™**ï¼š

1. **`AlertService`**ï¼šè² è²¬æ¥æ”¶å‘Šè­¦æ•¸æ“šã€åŒ¹é…è¦å‰‡ã€æª¢æŸ¥ç•°å¸¸ã€è¨˜éŒ„è§¸ç™¼æ—¥èªŒ
2. **`NotificationService`**ï¼šè² è²¬ç¯©é¸é€šçŸ¥ã€æ¸²æŸ“æ¨¡æ¿ã€ç™¼é€é€šçŸ¥ã€è¨˜éŒ„é€šçŸ¥æ—¥èªŒ

> æµç¨‹æ¦‚è¦½
>
> - `AlertService` â†’ **æª¢æŸ¥ç•°å¸¸ã€è¨˜éŒ„è§¸ç™¼æ—¥èªŒ**
> - `NotificationService` â†’ **ç™¼é€é€šçŸ¥ã€è¨˜éŒ„é€šçŸ¥æ—¥èªŒã€å¤±æ•—å‰‡è¨»å†Š `retry` ç™¼é€ä»»å‹™**

---

## **æœå‹™æ‹†è§£èªªæ˜**

## **1ï¸âƒ£ Alert Service**

ğŸ“Œ **æ­¥é©Ÿï¼šé è¼‰ã€åŒ¹é…ã€goroutine æª¢æŸ¥ã€æ›´æ–°ç‹€æ…‹ã€è¨˜éŒ„è§¸ç™¼æ—¥èªŒ**

**ä¸»è¦è² è²¬**

- **æ¥æ”¶** `AlertPayload`
- **é è¼‰** ç›£æ§è¦å‰‡ï¼ŒåŒ¹é…å‘Šè­¦å°è±¡ (`AutoApplyTarget`)ã€å‘Šè­¦è¦å‰‡ (`AutoApplyRule`)
- **ä¾ç…§ `Rule` ä½µç™¼åŸ·è¡Œ**ï¼š
  - `CheckSingle()` æª¢æŸ¥ç•°å¸¸ (`CheckAbsolute / CheckAmplitude`)
  - `updateAlertState()` æ›´æ–° `rule_states`
  - `processTriggerLog()` è¨˜éŒ„è§¸ç™¼æ—¥èªŒ

### **ğŸ”¹ Alert Service å…§éƒ¨æµç¨‹**

| **åŠŸèƒ½**                  | **æè¿°**                                          |
| ------------------------- | ------------------------------------------------- |
| **`CheckPayload()`**      | åˆæ­¥é©—è­‰ `AlertPayload`                           |
| **`AutoApplyTarget()`**   | è‡ªå‹•åŒ¹é…ç›£æ§å°è±¡                                  |
| **`AutoApplyRule()`**     | è‡ªå‹•åŒ¹é…å‘Šè­¦è¦å‰‡                                  |
| **`GetActiveRules()`**    | æŸ¥è©¢ç¬¦åˆæ¢ä»¶çš„è¦å‰‡                                |
| **`CheckSingle()`**       | åŸ·è¡Œç•°å¸¸æª¢æ¸¬ (`CheckAbsolute` / `CheckAmplitude`) |
| **`updateAlertState()`**  | æ›´æ–° `rule_states`                                |
| **`processTriggerLog()`** | å»ºç«‹ `TriggeredLog` è¨˜éŒ„                          |

## **2ï¸âƒ£ Notification Service**

ğŸ“Œ **æ­¥é©Ÿï¼šæŸ¥è©¢ã€åˆ†çµ„ã€æ¸²æŸ“æ¨¡æ¿ã€ç™¼é€é€šçŸ¥ã€è¨˜éŒ„ç™¼é€æ—¥èªŒã€å¤±æ•—å‰‡ `retry`**

**ä¸»è¦è² è²¬**

- **æŸ¥è©¢ `TriggeredLog`ï¼Œéæ¿¾ `ContactState`**
- **å°‡é€šçŸ¥åˆ†çµ„ (`ContactID`)ï¼Œä½µç™¼ç™¼é€**
- **æ¸²æŸ“å°æ‡‰ `Template`**
- **ç™¼é€é€šçŸ¥ (`Webhook, Email, Slack`)**
- **è¨˜éŒ„ `NotifyLog`**
- **é€šçŸ¥å¤±æ•—å‰‡ `retry` (`RetryDelay & MaxRetry`)**

### **ğŸ”¹ Notification Service å…§éƒ¨æµç¨‹**

| **åŠŸèƒ½**                         | **æè¿°**                                                   |
| -------------------------------- | ---------------------------------------------------------- |
| **`GetTriggeredLogs()`**         | æŸ¥è©¢æœªç™¼é€é€šçŸ¥çš„ `TriggeredLog`                            |
| **`GroupByContact()`**           | æŒ‰ `ContactID` åˆ†çµ„                                        |
| **`RenderTemplate()`**           | ä¾ `FormatType` æ¸²æŸ“æ¨¡æ¿ (`HTML / Markdown / JSON / Text`) |
| **`SendNotification()`**         | ç™¼é€é€šçŸ¥ (`Webhook, Email, Slack`)                         |
| **`RecordNotifyLog()`**          | è¨˜éŒ„ `NotifyLog`                                           |
| **`RetryFailedNotifications()`** | `retry` æ©Ÿåˆ¶ (`RetryDelay & MaxRetry`)                     |

---

## **æ ¸å¿ƒç‹€æ…‹ç¢¼**

âœ… **éœ€è¦ç¢ºèªæ¯å€‹ç‹€æ…‹éƒ½æœ‰æ­£ç¢ºæ‡‰ç”¨**

| **è¡¨å / æ¬„ä½**                   | **ç‹€æ…‹**   | **æè¿°**                        |
| --------------------------------- | ---------- | ------------------------------- |
| **`rule_states.rule_state`**      | `alerting` | ç•°å¸¸ç™¼ç”Ÿä¸­                      |
|                                   | `resolved` | å‘Šè­¦å·²æ¢å¾©                      |
|                                   | `normal`   | æ­£å¸¸ç‹€æ…‹                        |
|                                   | `disabled` | è¦å‰‡æœªå•Ÿç”¨                      |
| **`rule_states.contact_state`**   | `normal`   | æ­£å¸¸é€šçŸ¥                        |
|                                   | `silence`  | é€²å…¥ `silence_period`ï¼Œæš«åœé€šçŸ¥ |
|                                   | `disabled` | é€šé“æœªå•Ÿç”¨                      |
| `triggered_logs**.notify_state**` | `sent`     | ç•°å¸¸è¨Šæ¯ç™¼é€æˆåŠŸ                |
|                                   | `solved`   | æ¢å¾©è¨Šæ¯ç™¼é€æˆåŠŸ                |
|                                   | `pending`  | ç­‰å¾… `notify_pending_time`ç™¼é€  |
|                                   | `delayed`  | å»¶é²ç™¼é€                        |
|                                   | `failed`   | å¤±æ•—ï¼Œç­‰å¾… `retry`              |

---

# **å…§å»º YAML**

- **`metric_rule.yaml`** â†’ **å®šç¾©ç›£æ§æŒ‡æ¨™è¦å‰‡**
- **`template.yaml`** â†’ **å®šç¾©é€šçŸ¥æ¨¡æ¿**

---

# **MySQL è³‡æ–™åº«çµæ§‹**

âœ… **éœ€è¦ç¢ºèªæ¯å€‹æ¬„ä½éƒ½æœ‰æ­£ç¢ºæ›´æ–°**

| **è¡¨å**         | **ç”¨é€”**     |
| ---------------- | ------------ |
| `realms`         | ç§Ÿæˆ¶ç®¡ç†     |
| `targets`        | ç›£æ§å°è±¡     |
| `contacts`       | é€šçŸ¥é€šé“     |
| `rules`          | è¦å‰‡è¨­å®š     |
| `rule_states`    | ç•¶å‰è¦å‰‡ç‹€æ…‹ |
| `triggered_logs` | è§¸ç™¼æ—¥èªŒ     |
| `notify_logs`    | é€šçŸ¥æ—¥èªŒ     |

---

## å‚³é€ `AlertPayload.json`

```json
{
  "metadata": {
    "realm_name": "master",
    "datasource_type": "oracle_tablespace_script",
    "resource_name": "PSAPUNDO",
    "timestamp": 1725072363
  },
  "data": {
    "total_space_bytes:ADV:SYSAUX": [
      { "timestamp": 1725072303, "value": 485394.0 },
      { "timestamp": 1725072363, "value": 485592.0 }
    ],
    "total_space_usage:ADV:SYSAUX": [
      { "timestamp": 1725072303, "value": 63.0 },
      { "timestamp": 1725072363, "value": 63.0 }
    ]
  }
}
```

## `Alert` Service

## 1. ReadPayload

**ç›®çš„ï¼š**

- æª¢æŸ¥ payload æ ¼å¼ metadata è·Ÿ data

**é‡é»ï¼š**

- metadata.data é€ç­† key åˆ†å‰² [0]:[1] key[0]=metric å–å¾— key[1]= partition_name
- å¾ metadata çš„ realm_name è·Ÿ datasource_name è·Ÿ resource_name è·Ÿ partition_name å‘ DB å–å¾— targets ï¼Œtargets ids å– rules , rule_states
- å¦‚æœ data æ²’æœ‰åŒ¹é…åˆ° target ä»£è¡¨æ–°åŠ å…¥æ²’æœ‰è¨­å®šè¦å‰‡ï¼Œ rules å– auto_apply = true é€²è¡Œè¨­å®šè‡ªå‹•åŠ å…¥è¦å‰‡ï¼Œæ–° target æ ¹æ“š datasource_name è·Ÿ key[0]=metric åŒ¹é… metric_rule çš„ uid å¾—åˆ° rule ï¼Œç„¶å¾Œæ‰¹é‡æ–°å¢ rule
- å…ˆæŸ¥è©¢ Rulesï¼Œä½†ä¸é è¼‰ Contacts è§¸ç™¼æ™‚å†æ‰¹é‡æŸ¥è©¢ Contacts

## 2. AutoApplyTarget

**ç›®çš„ï¼š**

ç¢ºä¿æ”¶åˆ°çš„ alert å°æ‡‰çš„ target åœ¨è³‡æ–™åº«ä¸­å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å‰‡è‡ªå‹•æ–°å¢ targetã€‚

**é‡é»ï¼š**

- æª¢æŸ¥ payload ä¸­çš„ target è³‡è¨Š
- å¦‚ target ä¸å­˜åœ¨ï¼Œé€²è¡Œè‡ªå‹•ç”³è«‹èˆ‡è¨˜éŒ„

---

## 3. AutoApplyRule

**ç›®çš„ï¼š**

å°æ–¼æ–°åŠ å…¥çš„ targetï¼Œè‹¥è³‡æ–™ä¸­æœªåŒ¹é…åˆ°ç¾æœ‰è¦å‰‡ï¼Œå‰‡ä¾æ“š auto_apply æ¨™èªŒè‡ªå‹•å¥—ç”¨å°æ‡‰çš„ ruleã€‚

**é‡é»ï¼š**

- æ ¹æ“š datasource_name èˆ‡ key[0]ï¼ˆmetricï¼‰æ¯”å° MetricRules çš„ uid
- æ‰¹é‡æ–°å¢æˆ–æ›´æ–°ç¬¦åˆ auto_apply æ¢ä»¶çš„ rule

---

## 4. GetActiveRules

**ç›®çš„ï¼š**

å¾è³‡æ–™åº«ä¸­è®€å–ç•¶å‰ active çš„è¦å‰‡èˆ‡å…¶å°æ‡‰çš„ RuleStateï¼Œç¢ºä¿æª¢æŸ¥åŸºç¤è³‡æ–™å®Œæ•´ã€‚

**é‡é»ï¼š**

- æ ¹æ“š realmã€resource ç­‰é—œéµè³‡è¨ŠæŸ¥è©¢å°æ‡‰çš„ Rules
- åŒæ™‚å–å¾—å°æ‡‰çš„ MetricRulesï¼ˆéœæ…‹è¦å‰‡ï¼‰èˆ‡ RuleStatesï¼ˆå‹•æ…‹ç‹€æ…‹ï¼‰

---

## 5. CheckSingle(Absolute,Amplitude)

### CheckSingle

**ç›®çš„ï¼š**

- æ ¹æ“š detection_type é¸æ“‡æª¢æŸ¥æ–¹æ³•ï¼ˆabsolute/amplitudeï¼‰

é‡å°å–®ä¸€æ•¸æ“šé»é€²è¡Œæª¢æŸ¥ï¼Œç¢ºå®šæ˜¯å¦ç«‹å³è§¸ç™¼å‘Šè­¦é‚è¼¯ã€‚

**æµç¨‹ï¼š**

- å°‡ alert.Value ä¹˜ä¸Š metricRule.Scale å¾—åˆ°ç•¶å‰å€¼
- æ ¹æ“š operatorï¼ˆå¦‚ gtã€ltï¼‰æ¯”å° Threshold
- è¿”å›æ˜¯å¦ã€Œexceededã€èˆ‡ç•¶å‰è¨ˆç®—çš„ triggeredValue

### 5.1 CheckAbsolute(rule, Data)

**ç›®çš„ï¼š**

é€ç­†æª¢æŸ¥æœ€æ–° N ç­†æ•¸æ“šï¼Œç¢ºèªæ‰€æœ‰æ•¸æ“šå‡è¶…éé–¾å€¼å¾Œé€²è¡Œè§¸ç™¼ã€‚

**æµç¨‹ï¼š**

-
- æ¯”å° value èˆ‡ä¸åŒç­‰ç´šçš„ threshold (crit_threshold/warn_threshold/info_threshold)
- è¨ˆç®—ç•°å¸¸æŒçºŒæ™‚é–“ï¼š`now - first_trigger_at`
- æ ¹æ“š operator (< or >) åˆ¤æ–·ç•°å¸¸
- ä¾åš´é‡åº¦é †åºåˆ¤æ–· (crit â†’ warn â†’ info)
- è®€å–æœ€æ–° N ç­†æ•¸æ“š
- é©—è­‰æ¯ç­†æ•¸æ“šæ˜¯å¦å‡ç¬¦åˆæ¢ä»¶ï¼ˆå¤§æ–¼æˆ–å°æ–¼é–¾å€¼ï¼‰
- è‹¥æ‰€æœ‰æ•¸æ“šæ»¿è¶³ï¼Œè¨ˆç®— StackDurationï¼ˆnow - FirstTriggerTimeï¼‰
- åˆ¤æ–·æ˜¯å¦è¶…éé è¨­æŒçºŒæ™‚é–“ durationï¼Œæ±ºå®šæ˜¯å¦è§¸ç™¼

### 5.2 CheckAmplitude(rule, Data)

**ç›®çš„ï¼š**

æª¢æŸ¥æœ€è¿‘ N ç­†æ•¸æ“šçš„æŒ¯å¹…è®ŠåŒ–æ˜¯å¦è¶…å‡º Thresholdã€‚

**æµç¨‹ï¼š**

- è¨ˆç®— max_value èˆ‡ min_value
- è¨ˆç®—æŒ¯å¹…ï¼š`(max - min) / min * 100`
- èˆ‡ threshold æ¯”å°åˆ¤æ–·æ˜¯å¦ç•°å¸¸
- è®€å–æœ€æ–° N ç­†æ•¸æ“šï¼Œè¨ˆç®— max èˆ‡ min
- è¨ˆç®— amplitude = ((max - min) / min) \* 100
- åˆ¤æ–·æŒ¯å¹…å€¼æ˜¯å¦è¶…éè¨­å®šå€¼ï¼Œä¸¦è¨ˆç®— StackDuration
- è‹¥æŒçºŒæ™‚é–“ç¬¦åˆï¼Œè§¸ç™¼å‘Šè­¦

---

## 6. updateAlertState(rule, triggeredValue, currentTime)

**ç›®çš„ï¼š**

æ ¹æ“šæª¢æŸ¥çµæœæ›´æ–°è©² rule çš„ç‹€æ…‹ï¼ˆalerting / normal / resolvedï¼‰ï¼Œä¸¦è¨˜éŒ„å¿…è¦çš„æ™‚é–“èˆ‡è§¸ç™¼å€¼è³‡è¨Šã€‚

1. **éœéŸ³æ©Ÿåˆ¶**
   - ä½¿ç”¨ silence_start_at å’Œ silence_end_at æ§åˆ¶éœéŸ³æœŸé–“
   - éœéŸ³æœŸé–“ä¸ç™¼é€é€šçŸ¥ï¼Œä½†ä»è¨˜éŒ„å‘Šè­¦

- é¦–æ¬¡ç•°å¸¸æ™‚è¨­å®š first_trigger_at
- æŒçºŒç•°å¸¸æ›´æ–° last_trigger_at
- æ¢å¾©æ™‚è¨­å®š state = â€œnormalâ€ æˆ– â€œauto_resolvedâ€
- ä½¿ç”¨ diff æ–¹æ³•åƒ…æ›´æ–°è®Šå‹•æ¬„ä½

**æµç¨‹ï¼š**

- **ç•°å¸¸åˆ†æ”¯ï¼š**
  - è‹¥ç•¶å‰æª¢æŸ¥çµæœç‚ºç•°å¸¸ï¼Œæ›´æ–°ï¼š
    - `FirstTriggerTime`ï¼ˆè‹¥å°šæœªè¨˜éŒ„ï¼‰
    - `LastTriggerTime`
    - `TriggerValue`
    - è¨ˆç®— Â `StackDuration = now - FirstTriggerTime`
    - è‹¥ StackDuration è¶…é Durationï¼Œå°‡ RuleState æ›´æ–°ç‚º alerting
- **æ¢å¾©åˆ†æ”¯ï¼š**
  - è‹¥æª¢æŸ¥çµæœå›å¾©æ­£å¸¸ï¼Œå‰‡ï¼š
    - æ¸…é™¤ FirstTriggerTime
    - å°‡ RuleState æ›´æ–°ç‚º normal/resolved
    - æ›´æ–° TriggerLog çš„ resolved_atï¼ˆæˆ– closed_atï¼Œè¦– closed_type è€Œå®šï¼‰
- **DB å„ªåŒ–ï¼š**
  - æ¡ç”¨ diff æ›´æ–°ï¼Œåªå¯«å…¥æœ‰è®ŠåŒ–çš„æ¬„ä½ï¼Œæ¸›å°‘ DB å¯«å…¥æˆæœ¬

---

## 7. processTriggerLog(rule, alert, currentState) **Create or Update**

**ç›®çš„ï¼š**

æ ¹æ“š Rule State **åˆ¤æ–· éœ€è¦ Create é‚„æ˜¯ Update** TriggerLogï¼Œè¨˜éŒ„ç•¶å‰å‘Šè­¦å¿«ç…§

- è¨˜éŒ„å®Œæ•´ rule_snapshot èˆ‡ rule_state_snapshot
- æ ¹æ“š contact_state æ±ºå®šé€šçŸ¥ç­–ç•¥
- è¨˜éŒ„ triggered_value å’Œ threshold å€¼
- ç•°å¸¸æ¢å¾©æ™‚æ›´æ–° resolved_at
- æ‰‹å‹•é—œé–‰æ™‚æ›´æ–° closed_at å’Œ closed_by

## **åˆ¤æ–·çš„é‚è¼¯**

```
1. ç•¶ rule_state = normal -> alertingï¼š
   - ç”¢ç”Ÿæ–°çš„ TriggeredLogï¼Œä¸¦æ›´æ–° rule_state = alerting
   - è¨˜éŒ„ last_triggered_log_id ç‚ºè©²æ¬¡è§¸ç™¼çš„ log_id
2. ç•¶ rule_state = alertingï¼š
   - æ›´æ–°è©²æ¬¡ TriggeredLogï¼Œè¨˜éŒ„ç•°å¸¸è®ŠåŒ–
   - ä¸æ›´æ–° last_triggered_log_idï¼ˆæŒçºŒç•°å¸¸ï¼‰
3. ç•¶ rule_state = resolvedï¼š
   - æ¨™è¨˜ TriggeredLog.resolved_at
   - æ¸…ç©º last_triggered_log_id
```

## `Alert`Service Flow

```mermaid
flowchart TD
    A[ReadPayload]
    B[AutoApplyTarget]
    C[AutoApplyRule]
    D[GetActiveRules]
    E[å°æ¯ç­† Rule é€²è¡Œæª¢æŸ¥]
    F{é¸æ“‡æª¢æŸ¥æ–¹å¼}
    G[CheckSingle]
    H[CheckAbsolute]
    I[CheckAmplitude]
    J[updateAlertState]
    K[createTriggerLog]
    L[ProcessNotifyLog]
    M[sendNotifyLog]
    N[ProcessTriggerLogs]


    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F -- å–®ä¸€æª¢æŸ¥ --> G
    G -- é€£çºŒæª¢æŸ¥ --> H
    G -- æŒ¯å¹…æª¢æŸ¥ --> I
    H & I --> J
    J --> K
    K --> L
    L --> M
    M --> N

```

---

## `Notification` Service

## 1. æŸ¥è©¢èˆ‡éæ¿¾ (GetPendingTriggeredLogs)

- ä¸»è¦è·è²¬ï¼š
  é€é GetPendingNotifications å‡½å¼ï¼Œé¸å‡ºæ‰€æœ‰æ»¿è¶³æ¢ä»¶çš„ TriggeredLog ä½œç‚ºé€šçŸ¥è™•ç†çš„åŸå§‹è³‡æ–™ã€‚
- åŠŸèƒ½ï¼š
  å¾è³‡æ–™åº«ä¸­æŸ¥è©¢æ‰€æœ‰ç¬¦åˆä»¥ä¸‹æ¢ä»¶çš„ TriggeredLogï¼š
  - Timestamp å°æ–¼ç•¶å‰æ™‚é–“ï¼ˆå‘Šè­¦å·²ç”¢ç”Ÿï¼‰
  - è¯çµ¡æ–¹å¼ç‹€æ…‹é mute
  - ç•¶å‰æ™‚é–“å¤§æ–¼å¯‚éœæœŸï¼ˆSilenceEndï¼‰
  - NotifyState ç‚º nil æˆ– pendingï¼ˆå°šæœªé€šçŸ¥ï¼‰
  - ResolvedTime ç‚º 0ï¼ˆå‘Šè­¦ä»è™•æ–¼ç•°å¸¸ç‹€æ…‹ï¼‰
- æ±ºç­–é‡é»ï¼š
  - åƒ…è¿”å›æ»¿è¶³æ‰€æœ‰æ¢ä»¶çš„è¨˜éŒ„ï¼Œé¿å…é‡è¤‡æˆ–éŒ¯èª¤é€šçŸ¥ã€‚
  - ä½œç‚ºå¾ŒçºŒåˆ†çµ„èˆ‡åˆä½µçš„åŸºç¤è³‡æ–™ä¾†æºã€‚

---

## 2. åˆ†çµ„åˆä½µ (GroupByContact)

- ä¸»è¦è·è²¬ï¼š
  åˆ©ç”¨ GroupByContact å°‡ç›¸åŒè¯çµ¡äººçš„å‘Šè­¦è¨˜éŒ„åˆä½µï¼Œé™ä½é€šçŸ¥é‡è¤‡æ€§ä¸¦å„ªåŒ– API èª¿ç”¨ã€‚
- åŠŸèƒ½ï¼š
  æ ¹æ“šæŸ¥è©¢çµæœä¾ç…§ contact_idï¼ˆåŠå¿…è¦æ™‚ channel_typeï¼‰é€²è¡Œåˆ†çµ„ï¼Œå°‡å¤šç­† TriggeredLog æ•´åˆåˆä½µæˆä¸€ç­† NotifyLogã€‚
- æ±ºç­–é‡é»ï¼š
  - åˆä½µç›¸åŒè¯çµ¡äººçš„å¤šç­†å‘Šè­¦è³‡è¨Šï¼ˆå¦‚å‘Šè­¦æ‘˜è¦ã€ç™¼ç”Ÿæ™‚é–“ã€åš´é‡åº¦ï¼‰ã€‚
  - æ¸›å°‘é€šçŸ¥è«‹æ±‚ï¼Œé™ä½ç³»çµ±å£“åŠ›ï¼ŒåŒæ™‚æé«˜ä½¿ç”¨è€…çš„è¨Šæ¯å¯è®€æ€§ã€‚

---

## 3. æ¨¡æ¿æ¸²æŸ“ (RenderTemplate)

- ä¸»è¦è·è²¬ï¼š
  ä½¿ç”¨ RenderTemplate å°‡åˆä½µå¾Œçš„è³‡æ–™æ ¹æ“šè¯çµ¡äººåå¥½èˆ‡è¨­å®šæ¸²æŸ“æˆæœ€çµ‚é€šçŸ¥å…§å®¹ã€‚
- åŠŸèƒ½ï¼š
  æ ¹æ“šè¯çµ¡äººæˆ–è¦å‰‡è¨­å®šçš„ FormatType å°‡åˆä½µå¾Œçš„å‘Šè­¦è³‡æ–™æ¸²æŸ“æˆæœ€çµ‚é€šçŸ¥å…§å®¹ã€‚
- æµç¨‹èˆ‡æ±ºç­–ï¼š
  - æ¨¡æ¿é¸æ“‡ï¼š æ ¹æ“šè¨­å®šé¸ç”¨ HTMLã€Markdownã€JSON æˆ– Text æ¨¡æ¿ï¼›è‹¥æœªæŒ‡å®šå‰‡é è¨­ç‚º Textã€‚
  - æ•¸æ“šæ˜ å°„ï¼š å°‡åˆä½µå¾Œçš„ TriggeredLog è³‡æ–™ï¼ˆç•°å¸¸é¡å‹ã€ç™¼ç”Ÿæ™‚é–“ã€å½±éŸ¿ç¯„åœã€æ‘˜è¦ç­‰ï¼‰å‚³å…¥æ¨¡æ¿å¼•æ“é€²è¡Œæ¸²æŸ“ã€‚
  - éŒ¯èª¤è™•ç†ï¼š æ¨¡æ¿æ¸²æŸ“å¤±æ•—æ™‚å›å‚³éŒ¯èª¤ï¼Œè§¸ç™¼é‡è©¦æˆ–è¨˜éŒ„éŒ¯èª¤è¨Šæ¯ã€‚

---

## 4. é€šçŸ¥ç™¼é€ (SendNotification)

- ä¸»è¦è·è²¬ï¼š
  é€šé SendNotification ä¾æ“šä¸åŒæ¸ é“ç™¼é€é€šçŸ¥ï¼Œä¸¦çµåˆ worker pool æ§åˆ¶ä¸¦ç™¼æ•¸é‡ä»¥ä¿éšœç³»çµ±ç©©å®šæ€§ã€‚
- åŠŸèƒ½ï¼š
  å°‡æ¸²æŸ“å¾Œçš„é€šçŸ¥å…§å®¹é€éå°æ‡‰çš„æ¸ é“ï¼ˆWebhookã€Emailã€Slack ç­‰ï¼‰ç™¼é€çµ¦ç›®æ¨™è¯çµ¡äººã€‚
- æµç¨‹èˆ‡æ±ºç­–ï¼š
  - æ¸ é“èª¿ç”¨ï¼š æ ¹æ“šè¯çµ¡äººè¨­å®šé¸æ“‡åˆé©çš„ API å‘¼å«æ–¹æ³•ã€‚
  - è¶…æ™‚èˆ‡éŒ¯èª¤æ•æ‰ï¼š è¨­å®šåˆç†çš„è¶…æ™‚æ©Ÿåˆ¶ï¼Œæ•æ‰ç¶²çµ¡ç•°å¸¸æˆ– API éŒ¯èª¤ã€‚
  - Worker Pool æ§åˆ¶ï¼š ä½¿ç”¨ worker pool é™åˆ¶åŒæ™‚ç™¼é€çš„é€šçŸ¥æ•¸é‡ï¼Œé¿å…éé‡ä½µç™¼å°è‡´ç³»çµ±ä¸ç©©ã€‚

---

## 5. é€šçŸ¥æ—¥èªŒè¨˜éŒ„èˆ‡ç‹€æ…‹æ›´æ–° (RecordNotifyLog)

- ä¸»è¦è·è²¬ï¼š
  RecordNotifyLog è² è²¬å°‡ç™¼é€çµæœè¨˜éŒ„ä¸‹ä¾†ï¼Œä¸¦åŒæ­¥æ›´æ–° TriggeredLog ç‹€æ…‹ï¼ˆä¾‹å¦‚å¾ pending è®Šç‚º sent æˆ–è¨˜éŒ„å¤±æ•—ä¿¡æ¯ï¼‰ã€‚
- åŠŸèƒ½ï¼š
  å°‡é€šçŸ¥ç™¼é€çš„çµæœè¨˜éŒ„åœ¨ notify_logs ä¸­ï¼Œä¸¦æ›´æ–°ç›¸é—œ TriggeredLog ç‹€æ…‹ï¼ˆå¦‚å°‡ pending è®Šç‚º sent æˆ–æ¨™è¨˜å¤±æ•—ï¼‰ã€‚
- æ±ºç­–é‡é»ï¼š
  - ç‹€æ…‹åŒæ­¥ï¼š åŒæ™‚æ›´æ–° TriggeredLog èˆ‡ NotifyLogï¼Œå»ºç«‹é›™å‘é—œè¯ï¼ˆä¾‹å¦‚è¨˜éŒ„ notify_log_idï¼‰ã€‚
  - åŸå­æ€§æ›´æ–°ï¼š ç¢ºä¿è³‡æ–™åº«æ“ä½œåŸå­æ€§ï¼Œé¿å…ç‹€æ…‹ä¸ä¸€è‡´ã€‚
  - ç´¯è¨ˆé‡è©¦ï¼š ç•¶ç™¼é€å¤±æ•—æ™‚ç´¯è¨ˆ retry_counterï¼Œä¸¦è¨˜éŒ„æœ€å¾Œé‡è©¦æ™‚é–“ï¼ˆlast_retry_timeï¼‰ã€‚

---

## 6. é‡è©¦æ©Ÿåˆ¶ (RetryFailedNotifications)

- ä¸»è¦è·è²¬ï¼š
  è‹¥ç™¼é€å¤±æ•—ï¼ŒRetryFailedNotifications å®šæœŸæª¢æŸ¥å¤±æ•—è¨˜éŒ„ä¸¦æ ¹æ“šé‡è©¦å»¶é²èˆ‡é‡è©¦æ¬¡æ•¸æ¢ä»¶ï¼Œé‡æ–°å˜—è©¦ç™¼é€ï¼Œç›´è‡³æˆåŠŸæˆ–è¶…å‡ºé‡è©¦ä¸Šé™ã€‚
- åŠŸèƒ½ï¼š
  é‡å°ç™¼é€å¤±æ•—çš„ NotifyLog é€²è¡Œé‡è©¦ï¼Œç¢ºä¿é€šçŸ¥æœ€çµ‚èƒ½å¤ é€é”ã€‚
- æµç¨‹èˆ‡æ±ºç­–ï¼š
  - é‡è©¦æ¢ä»¶ï¼š æª¢æŸ¥ last_retry_time èˆ‡ retry_delay æ˜¯å¦åˆ°æœŸï¼Œä¸” retry_counter æœªè¶…é max_retryã€‚
  - é‡è©¦æµç¨‹ï¼š å¦‚æœæ¢ä»¶æ»¿è¶³ï¼Œé‡æ–°å‘¼å« SendNotificationï¼›æˆåŠŸå¾Œæ›´æ–°ç‹€æ…‹ç‚º sentï¼Œå¤±æ•—å‰‡ç´¯åŠ é‡è©¦æ¬¡æ•¸ä¸¦æ›´æ–° last_retry_timeã€‚
  - åˆ†é›¢æ©Ÿåˆ¶ï¼š é€šéç¨ç«‹çš„ Retry Worker å®šæ™‚ï¼ˆä¾‹å¦‚æ¯åˆ†é˜ï¼‰æƒæå¤±æ•—è¨˜éŒ„ï¼Œé¿å…é‡è©¦æ“ä½œå½±éŸ¿æ–°é€šçŸ¥çš„ç™¼é€ã€‚

---

## 7. å»¶é²é€šçŸ¥æ©Ÿåˆ¶ (HandleNotifyPendingTime)

- ä¸»è¦è·è²¬ï¼š
  é€é HandleNotifyPendingTime æª¢æŸ¥ä¸¦ç®¡ç†å»¶é²é€šçŸ¥æ©Ÿåˆ¶ï¼Œç¢ºä¿åªæœ‰åœ¨å»¶é²æœŸæ»¿ä¸”å‘Šè­¦æŒçºŒçš„æƒ…æ³ä¸‹ï¼Œæ‰é€²å…¥å¾ŒçºŒé€šçŸ¥æµç¨‹ã€‚
- åŠŸèƒ½ï¼š
  ç•¶ TriggeredLog å‰›ç”¢ç”Ÿæ™‚ï¼Œæ ¹æ“šé…ç½®çš„ notify_pending_time æ±ºå®šæ˜¯å¦å»¶é²ç™¼é€é€šçŸ¥ï¼Œé¿å…çŸ­æ™‚é–“å…§é »ç¹ç™¼é€ã€‚
- æµç¨‹èˆ‡æ±ºç­–ï¼š
  - æª¢æŸ¥å»¶é²è¨­å®šï¼š è‹¥ notify_pending_time = 0ï¼Œå‰‡ç«‹å³é€²å…¥é€šçŸ¥æµç¨‹ï¼›è‹¥å¤§æ–¼ 0ï¼Œå‰‡é€²å…¥ç­‰å¾…ç‹€æ…‹ã€‚
  - ç­‰å¾…ç›£æ§ï¼š åœ¨å»¶é²æœŸé–“å…§æŒçºŒæª¢æŸ¥ rule_stateï¼š
    - è‹¥åœ¨ç­‰å¾…æœŸé–“ç•°å¸¸æ¢å¾©ï¼ˆrule_state = resolvedï¼‰ï¼Œå‰‡å–æ¶ˆé€šçŸ¥ï¼Œå°‡ TriggeredLog æ¨™è¨˜ç‚º ignoredã€‚
    - è‹¥å»¶é²æœŸçµæŸä¸”ä»ç‚º alertingï¼Œå‰‡è½‰ç‚º pendingï¼Œé€²å…¥å¾ŒçºŒé€šçŸ¥æµç¨‹ã€‚

## \*\*\*\*`Notification` Service Flow

```mermaid
graph TD;
    A[GetPendingTriggeredLogs]
      --> B[éæ¿¾ Contact ç‹€æ…‹]
    B --> C[GroupByContact]
    C --> D[HandleNotifyPendingTime]
    D --> E[RenderTemplate]
    E --> F[RendNotification]
    F --> G{ç™¼é€æˆåŠŸ?}
    G -- æ˜¯ --> H[RecordNotifyLog]
    G -- å¦ --> I[RetryFailedNotifications]
    I -- é‡è©¦æˆåŠŸ --> H
    I -- é‡è©¦è¶…é™ --> J[æœ€çµ‚æ¨™è¨˜å¤±æ•—]
```
